const express = require('express');
const rp = require('request-promise');
const lodash = require('lodash');
const app = express();

app.get('/', async (req, res) => {
    let memes;
    do {
        memes = await getMemes(subRedditsList[lodash.random(0, subRedditsList.length - 1, false)]);
    } while (lodash.isEmpty(memes))
    const memeUrl = memes[lodash.random(0, memes.length - 1, false)];
    console.log(memeUrl);
    const ext = memeUrl.match(/[.]\w+/i);
    switch (ext)
    {
        case '.gifv':
            res.send(await rp.get({
                uri: 'data:image/jpeg;base64,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'
            }));
            break;
        case '.gif':
            res.send(await rp.get({
                uri: memeUrl
            }));
            break;
        default:
            res.send(`<img src="${memeUrl}">`);
            break;
    }
})
const subRedditsList = [
    'https://www.reddit.com/r/all.json',
    'https://www.reddit.com/r/uwaterloo.json'
]
const domainsWhitelist = ['i.imgur.com', 'i.redd.it']
const getMemes = async function(uri) {
    const redditJSON = await rp.get({
        uri,
        json: true
    });
    return lodash.compact(lodash.map(redditJSON.data.children, (post) => {
        if (domainsWhitelist.includes(post.data.domain))
        return post.data.url;
    }));
}

app.listen(8081);